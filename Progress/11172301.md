# MyPlaylist 프로젝트 진행 상황 (2025-11-17)

## 1. 주요 개선 사항 및 해결된 문제

### 1.1. 검색 페이지 및 트랙 추가 기능 개선
-   **기본 검색어 제거**: 검색 페이지 (`/search`) 초기 로딩 시 기본 검색어 "love"를 제거하고, 검색창만 표시되도록 수정했습니다. 사용자가 직접 검색어를 입력해야 결과가 나타납니다.
-   **무한 스크롤 구현**: 검색 결과 페이지 (`/search`)에서 스크롤을 내리면 다음 페이지의 트랙들이 자동으로 로드되어 추가됩니다.
    -   이를 위해 백엔드에 `/api/search` 엔드포인트를 추가하여 JSON 형태로 트랙 데이터를 반환하도록 했습니다.
    -   프론트엔드 JavaScript가 스크롤 이벤트를 감지하고 비동기적으로 데이터를 가져와 화면에 추가합니다.
-   **비동기 트랙 추가 (모달 및 토스트 알림)**:
    -   "Add to Playlist" 버튼 클릭 시 페이지 이동 없이, 트랙 정보를 담은 모달(Modal) 창이 나타나 플레이리스트를 선택할 수 있도록 변경했습니다.
    -   트랙 추가 요청은 JavaScript `fetch` API를 통해 비동기적으로 처리됩니다.
    -   추가 성공/실패 여부는 화면 우측 하단에 나타나는 토스트(Toast) 알림으로 사용자에게 피드백을 제공합니다. 알림에는 해당 플레이리스트로 이동할 수 있는 링크가 포함됩니다.
    -   이 기능은 검색 결과 페이지 (`search-results.html`)와 나의 Top 트랙 페이지 (`top-tracks.html`)에 모두 적용되었습니다.
-   **중복 트랙 추가 방지**: 플레이리스트에 이미 존재하는 트랙을 다시 추가하려고 할 경우, 데이터베이스 에러(500 오류)가 발생하는 대신, 중복 추가를 방지하고 토스트 알림으로 사용자에게 해당 사실을 알립니다.

### 1.2. 로그인 및 사용자 등록 문제 해결
-   **Spotify 개발자 대시보드 설정 문제 해결**: 신규 사용자 및 특정 기존 사용자가 로그인하지 못했던 문제는 애플리케이션 코드의 문제가 아닌, Spotify 개발자 대시보드에서 해당 Spotify 계정이 애플리케이션의 '테스터'로 등록되지 않아 발생한 `403 Forbidden` 에러였습니다. 이 문제는 Spotify 대시보드에서 앱을 '공개 모드'로 전환하거나, 테스트 계정을 수동으로 추가하여 해결할 수 있습니다.
-   **CSRF 토큰 누락 문제 해결**: 비동기 `POST` 요청(트랙 추가 등) 시 `403 Forbidden` 에러가 발생했던 문제는 JavaScript `fetch` 요청에 Spring Security의 CSRF 토큰이 포함되지 않아 발생했습니다.
    -   각 HTML 페이지의 `<head>` 섹션에 CSRF 토큰을 위한 `<meta>` 태그를 직접 추가했습니다.
    -   JavaScript 코드에서 이 `<meta>` 태그로부터 CSRF 토큰을 읽어 `fetch` 요청의 헤더에 포함시켜 전송하도록 수정했습니다.

### 1.3. 코드 리팩토링 및 개선
-   `CustomOAuth2UserService`의 사용자 생성 로직을 강화하여, Spotify에서 제공하는 `username`이나 `email`이 `null`이거나 데이터베이스에 중복될 경우 고유한 플레이스홀더 값을 생성하도록 했습니다.
-   `CustomAuthorizationRequestResolver`를 구현하여 Spotify 로그인 시 `approval_prompt=force` 파라미터를 강제함으로써, 항상 리프레시 토큰을 안정적으로 발급받을 수 있도록 했습니다.
-   디버깅을 위해 임시로 추가했던 상세 로그들을 제거하여 코드를 깔끔하게 정리했습니다.

## 2. 다음 작업 계획

-   **플레이리스트 내 곡 삭제 기능 구현**: 플레이리스트 상세 페이지에서 특정 곡을 삭제할 수 있는 기능을 추가합니다.
-   **플레이리스트 삭제 기능 구현**: 사용자가 자신의 플레이리스트를 삭제할 수 있는 기능을 추가합니다.


# 플레이리스트 내 곡 삭제 기능 구현 계획

이 기능은 사용자가 플레이리스트 상세 페이지(playlist-detail.html)에서 특정 곡 옆에 있는 '삭제' 버튼을 눌렀을 때 동작합니다.    

1. 백엔드 (Controller & Mapper):                                                                                                                                     
   * PlaylistTrackMapper: playlist_tracks 테이블에서 특정 레코드를 삭제하는 deleteTrackInPlaylist(long playlistTrackId) 메소드를 추가합니다. (playlist_id와         
   track_id의 조합 대신, 각 레코드의 고유 ID인 id를 사용하는 것이 더 안전하고 간단합니다.)                                                                        
   * PlaylistController: 삭제 요청을 처리할 새로운 엔드포인트(예: @PostMapping("/tracks/delete"))를 추가합니다. 이 엔드포인트는 playlistTrackId를 파라미터로 받아,  
     해당 매퍼 메소드를 호출하여 DB에서 데이터를 삭제합니다. 페이지 새로고침 없이 동작하도록 JSON 형태로 { "success": true } 와 같은 성공 여부를 반환합니다.

2. 프론트엔드 (HTML & JavaScript):
    * playlist-detail.html: 각 트랙 목록 옆에 '삭제(Delete)' 버튼을 추가합니다.
    * JavaScript: '삭제' 버튼 클릭 시, 페이지 이동 없이 fetch API를 사용하여 위에서 만든 백엔드 삭제 엔드포인트를 비동기적으로 호출합니다.
    * 요청이 성공하면, JavaScript는 화면에서 해당 트랙이 포함된 행(row)을 즉시 제거하여 사용자가 삭제 결과를 바로 볼 수 있도록 합니다.

  ---                                                                                                                                                                   

# 플레이리스트 삭제 기능 구현 계획

이 기능은 '나의 플레이리스트' 목록 페이지(playlist-my.html)에서 특정 플레이리스트를 삭제할 때 사용됩니다.

1. 백엔드 (Controller & Mapper):
    * PlaylistMapper: 특정 플레이리스트를 삭제하는 deletePlaylist(int playlistId) 메소드를 추가합니다.
    * PlaylistTrackMapper: 특정 플레이리스트에 속한 모든 트랙을 삭제하는 deleteAllTracksInPlaylist(int playlistId) 메소드를 추가합니다. (플레이리스트를 지우기 전에,
      관련된 트랙들을 먼저 정리해야 데이터베이스 무결성이 유지됩니다.)
    * PlaylistController: 플레이리스트 삭제 요청을 처리할 엔드포인트(예: @PostMapping("/delete"))를 추가합니다. 이 메소드는 내부적으로 deleteAllTracksInPlaylist와   
      deletePlaylist를 순서대로 호출하는 트랜잭션(Transaction)으로 처리해야 합니다. (둘 중 하나라도 실패하면 모두 롤백되도록)

2. 프론트엔드 (HTML & JavaScript):
    * playlist-my.html: 각 플레이리스트 항목 옆에 '삭제(Delete)' 버튼을 추가합니다.
    * JavaScript: 사용자의 실수를 방지하기 위해, '삭제' 버튼 클릭 시 "정말로 삭제하시겠습니까?" 와 같은 확인 대화상자(confirm dialog)를 띄웁니다.
    * 사용자가 '확인'을 누르면, fetch를 사용하여 백엔드의 플레이리스트 삭제 엔드포인트를 호출합니다.
    * 삭제가 성공하면, 화면에서 해당 플레이리스트 항목을 제거합니다.                                                        