# MyPlaylist 프로젝트 진행 상황 (2025-11-16)

## 1. 이전 목표 및 구현 완료

-   `Progress/11150030.md` 파일에 명시된 목표들을 기반으로 프로젝트를 진행했습니다.
-   **플레이리스트 상세 페이지**: 사용자가 생성한 플레이리스트를 클릭하면 수록된 곡 목록을 볼 수 있는 기능을 구현했습니다.
-   **UI/UX 개선**: 모든 페이지에 Bootstrap을 적용하고 일관된 상단 네비게이션 바(`global-top.html`)를 구현하여 전체적인 사용자 경험을 현대화하고 개선했습니다.

## 2. 핵심 문제 해결: 로그인 및 회원가입 안정화

프로젝트 진행 중 신규 사용자 및 일부 기존 사용자가 로그인할 수 없는 치명적인 문제가 발생했습니다. 이 문제를 해결하기 위해 다음과 같은 다각적인 디버깅과 수정 작업을 진행했습니다.

1.  **DB 스키마 문제 해결**: `users` 테이블에 `spotify_access_token_expires_at` 컬럼이 없어 발생했던 초기 오류를 해결했습니다.

2.  **리프레시 토큰(Refresh Token) 문제 해결**:
    -   **문제 분석**: 일부 사용자(특히 신규 가입자)가 Spotify로부터 리프레시 토큰을 받지 못해, Access Token 만료(1시간) 후 로그인이 불가능해지는 현상을 발견했습니다.
    -   **해결**: Spring Security 설정을 커스터마이징하여(`CustomAuthorizationRequestResolver`), 로그인 시 `approval_prompt=force` 파라미터를 강제함으로써 항상 새로운 리프레시 토큰을 발급받도록 로직을 수정했습니다.

3.  **사용자 등록 로직 강화**:
    -   **문제 분석**: `username` 및 `email`의 `UNIQUE` 및 `NOT NULL` 제약조건으로 인해 신규 사용자 등록이 실패하는 경우를 발견했습니다. (Spotify가 `display_name`이나 `email`을 제공하지 않거나, 이미 DB에 존재하는 경우)
    -   **해결**: `CustomOAuth2UserService`에서 신규 사용자 정보를 생성할 때, `username`이나 `email`이 없거나 중복될 경우 `spotify_user_id`를 기반으로 고유한 값을 생성하여 저장하도록 로직을 강화했습니다.

4.  **근본 원인 발견 및 해결**:
    -   **문제 분석**: 위 모든 조치 후에도 문제가 간헐적으로 발생하여, DEBUG 레벨 로깅을 통해 근본 원인을 추적했습니다. 로그 분석 결과, Spring Security가 Spotify API로부터 사용자 정보를 요청할 때 `403 Forbidden: "the user may not be registered."` 오류가 발생하는 것을 확인했습니다.
    -   **해결**: 이는 **Spotify 개발자 대시보드 설정 문제**였습니다. 개발 모드의 애플리케이션은 'Users and Access' 탭에 명시적으로 등록된 테스터 계정만 로그인을 허용합니다. 사용자가 이 설정에 테스트 계정을 추가함으로써 모든 로그인 문제가 최종적으로 해결되었습니다.

## 3. 최종 상태 및 추가 개선 사항

-   **안정적인 인증**: 신규 및 기존 사용자 모두 안정적으로 로그인 및 회원가입이 가능합니다.
-   **Spotify API 변경 대응**: 접근이 불가능해진 'Global Top 50' 기능을 제거하고, 개인화된 'My Top Tracks' 기능으로 대체했습니다.
-   **코드 정리**: 디버깅을 위해 추가했던 임시 코드를 모두 제거하고, 최종적으로 안정화된 로직만 남겨 코드의 청결성을 확보했습니다.

이제 애플리케이션의 핵심 기능이 안정적으로 작동하는 상태입니다.
